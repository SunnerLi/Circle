<!-- Usage: python3 -m http.server -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>台北市機能地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- sql.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

  <style>
    /* 地圖 */
    #map { height: 100vh; width: 100%; }

    /* 店家標記 */
    .marker-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .color-button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .custom-marker {
      width: 25px;
      height: 41px;
      border-radius: 4px;
      position: relative;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }

    .custom-marker::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-top-color: inherit;
    }

    /* 控制面板 */
    .sub-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .sub-list.open {
      max-height: 500px; /* 根據內容大小調整 */
    }

    .toggle-btn.open {
      transform: rotate(90deg);
      transition: transform 0.3s ease;
    }

    .toggle-btn {
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <button onclick="export_db()" class="absolute bottom-2 right-2 mt-4 px-4 py-2 bg-blue-500 text-white z-[1000] rounded-lg">
    下載 SQLite 資料庫
  </button>

  <!-- 控制面板 -->
  <div class="absolute top-4 right-4 flex items-start space-x-2 z-[1000]">
    <!-- 地區 Panel -->
    <div id="region-panel" class="bg-white rounded-xl shadow-lg p-4 font-sans w-48">
      <h2 class="text-gray-800 text-sm font-semibold mb-2">地區</h2>
    </div>

    <!-- 機能 Panel -->
    <div class="bg-white rounded-xl shadow-lg p-4 font-sans w-96">
      <h2 class="text-gray-800 text-sm font-semibold mb-2">機能選項</h2>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 建立資料庫物件
    let db = null;
    let SQL = null;

    // 建立地圖
    const map = L.map('map').setView([25.0330, 121.5654], 13); // 台北市中心

    // 宣告圖層相關物件
    let circles = {}
    let markers = {}

    // 加入 OpenStreetMap 圖層
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 初始化 sql.js 與資料庫
    initSqlJs({ 
      locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${filename}`
    }).then(_SQL => {
      SQL = _SQL;
      load_db("shops.sqlite");
    });

    // 暫停函式
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 載入本地資料庫
    async function load_db(filename) {
      try {
        const res = await fetch(filename);
        if (!res.ok) {
          console.warn(`${filename} 不存在，創建新資料庫`);
          db = new SQL.Database();
          create_db();
          return;
        }

        const buf = await res.arrayBuffer();
        const u8 = new Uint8Array(buf);
        db = new SQL.Database(u8);
        console.log(`${filename} 載入成功`);
      } catch (err) {
        console.error("載入資料庫發生錯誤:", err);
        db = new SQL.Database();
        create_db();
      }
    }

    // 創建表格函式
    function create_db() {
      const createTableSQL = `
        CREATE TABLE IF NOT EXISTS shops (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          city TEXT,
          category TEXT,
          shop TEXT,
          latitude REAL,
          longitude REAL,
          color TEXT
        );
      `;
      db.run(createTableSQL);
    }

    // 查詢本地資料庫
    function query_db(cities, category, shop) {
      create_db();
      const placeholders = cities.map(() => '?').join(',');
      const stmt = db.prepare(`
        SELECT * FROM shops
        WHERE city IN (${placeholders}) AND category = ? AND shop = ?;
      `);
      const result = [];
      stmt.bind([...cities, category, shop]);
      while (stmt.step()) {
        result.push(stmt.getAsObject());
      }
      stmt.free();
      return result;
    }

    // 查詢Open Street伺服器
    async function query_server(cities, category, shop, color) {
      const data = query_db(cities, category, shop);
      if (data.length > 0) {
        console.log("DB has data:", data);
        return data;
      }

      let allResults = [];
      for (const city of cities) {
        const overpassQuery = `
          [out:json][timeout:25];
          area["name"="${city}"]->.searchArea;
          (
            node["name"~"${shop}"](area.searchArea);
            way["name"~"${shop}"](area.searchArea);
            relation["name"~"${shop}"](area.searchArea);
          );
          out center;
        `;

        for (let i = 0; i < 5; i++) {
          // 定義OpenStreetMap的API URL
          const url = [
            'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery),
            'https://overpass.kumi.systems/api/interpreter?data=' + encodeURIComponent(overpassQuery),
            'https://overpass.osm.ch/api/interpreter?data=' + encodeURIComponent(overpassQuery),
          ][Math.floor(Math.random() * (2 - 0 + 1)) + 0]

          try {
            console.log(url)
            const res = await fetch(url);
            if (res.ok) {
              const json = await res.json();
              console.log(`第${i}次. #${shop}: ` + json.elements.length)
              if (json.elements.length > 0) {
                update_db(json, city, category, shop, color);
                allResults.push(...json.elements);
                break
              }
            } else {
              console.log(`第${i}次不ok.`)
              await sleep(Math.floor(Math.random() * (30000 - 1000 + 1)) + 1000)
            }
          } catch (e) {
            console.error("Failed Overpass API for city:", city, e);
          }
        }
      }

      return query_db(cities, category, shop);
    }

    // 更新本地資料庫
    function update_db(res, city, category, shop, color) {
      try {
        const insertSQL = `
          INSERT INTO shops (city, category, shop, latitude, longitude, color)
          VALUES (?, ?, ?, ?, ?, ?);
        `;
        const stmt = db.prepare(insertSQL);

        for (const el of res.elements) {
          console.log(el)
          let lat = el.lat || (el.center && el.center.lat);
          let lon = el.lon || (el.center && el.center.lon);
          if (lat !== undefined && lon !== undefined) {
            stmt.run([city, category, shop, lat, lon, color]);
          }
        }

        stmt.free();
      } catch (e) {
        console.error("[錯誤]", e)
      }
    }

    function export_db() {
      const binaryArray = db.export(); // 匯出為 Uint8Array
      const blob = new Blob([binaryArray], { type: "application/octet-stream" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "shops.sqlite"; // 你要下載的檔名
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function compute(rows) {
      rows.forEach(row => {
        markers[row.category][row.shop] = markers[row.category][row.shop].concat(
          L.marker([row.latitude, row.longitude], {icon: createDivIcon(row.shop, row.color)})
        )
        circles[row.category][row.shop] = circles[row.category][row.shop].concat(
          L.circle([row.latitude, row.longitude], {
            radius: 200,
            color: row.color,
            fillOpacity: 0.1
          })
        )
      })
    }

    function createDivIcon(shop_name, color) {
      return L.divIcon({
        className: '',
        html: `<div class="custom-marker" style="background-color:${color}; border-top-color:${color};">
                <span>${shop_name}</span>
               </div>`,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, -41]
      });
    }

    function draw(category, shop) {
      circles[category][shop].forEach(circle => {
        circle.addTo(map)
      })
      markers[category][shop].forEach(marker => {
        marker.addTo(map).bindPopup(shop)
      })
    }

    function erase(category, shop) {
      circles[category][shop].forEach(circle => {
        map.removeLayer(circle)
      })
      markers[category][shop].forEach(marker => {
        map.removeLayer(marker)
      })
    }

    /**
     * 處理點擊/取消點擊商店checkbox的行為
     */
    function toggle_shop(event, category, shop, color) {
      const selectedCities = get_selected_cities();
      if (event.target.checked) {
        query_server(selectedCities, category, shop, color).then(rows => {
          compute(rows)
          draw(category, shop)
        })
      } else {
        erase(category, shop)
      }
    }

    function get_selected_cities() {
      const selectedCities = [];
      const regionCheckboxes = document.querySelectorAll('#region-panel input[type="checkbox"]:checked');
      regionCheckboxes.forEach(checkbox => {
        const label = checkbox.closest('label');
        if (label) {
          const span = label.querySelector('span');
          if (span) {
            selectedCities.push(span.textContent.trim());
          }
        }
      });
      return selectedCities.length > 0 ? selectedCities : ["台北市"]; // Default to 台北市 if none selected
    }

    /**
     * 處理點擊/取消點擊餐廳類別checkbox的行為
     */
    function toggle_category(event, category_id) {
      const mainCheckbox = document.getElementById(category_id)
      const itemDiv = mainCheckbox.closest('.mb-4')
      const subList = itemDiv.querySelector('.sub-list')
      const subCheckboxes = subList.querySelectorAll('input[type="checkbox"]')

      if (event.target.checked) {
        expandSublist(category_id)
        subCheckboxes.forEach(cb => {if (!cb.checked) {cb.click()}});
      } else {
        subCheckboxes.forEach(cb => {if (cb.checked) {cb.click()}});
      }
    }

    /**
     * 處理點擊地區checkbox的行為
     */
    function handle_region_change(regionId, regions) {
      const regionCheckboxes = document.querySelectorAll('#region-panel input[type="checkbox"]');
      regionCheckboxes.forEach(checkbox => {
        if (checkbox.id !== regionId) {
          checkbox.checked = false;
        }
      });

      const selectedRegion = regions.find(r => r.id === regionId);
      if (selectedRegion) {
        map.setView([selectedRegion.lat, selectedRegion.lng], 13);
      }
    }

    // UI渲染函數
    function createRegionBlock({ id, label }) {
      const container = document.createElement("div");
      container.className = "mb-2";
      container.innerHTML = `
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="${id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">${label}</span>
        </label>
      `;
      return container;
    }

    function createCategoryBlock({ id, label, items }) {
      const container = document.createElement("div");
      container.className = "mb-4 border-b border-gray-300";
      container.innerHTML = `
        <div class="flex justify-between items-center">
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="${id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">${label}</span>
          </label>
          <button class="toggle-btn text-gray-600">▶</button>
        </div>

        <div class="sub-list pl-6 flex flex-wrap mt-2">
          ${items.map(item => `
            <div class="flex items-center space-x-1 w-1/3 mb-2">
              <label class="inline-flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="${item.id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
                <span class="text-sm text-gray-900">${item.label}</span>
              </label>
            </div>
          `).join('')}
        </div>
      `;
      return container;
    }

    // 手動展開子列表
    function expandSublist(mainId, expand = true) {
      const mainCheckbox = document.getElementById(mainId);
      const itemDiv = mainCheckbox?.closest(".mb-4");
      const subList = itemDiv?.querySelector(".sub-list");
      const toggleBtn = itemDiv?.querySelector(".toggle-btn");

      if (subList && toggleBtn) {
        subList.classList.toggle("open", expand);
        toggleBtn.classList.toggle("open", expand);
      }
    }

    // 讀取JSON設定檔並根據內容渲染面板
    fetch('setting.json')
      .then(res => res.json())
      .then(data => {
        // 初始化圖層相關變數
        data["life_function"].forEach(cat => {
          circles[cat["label"]] = {}
          markers[cat["label"]] = {}
          cat["items"].forEach(item => {
            circles[cat["label"]][item["label"]] = []
            markers[cat["label"]][item["label"]] = []
          })
        })

        // 定位並動態插入地區面板
        const regionPanel = document.getElementById("region-panel");
        data["regions"].forEach(region => {
          const block = createRegionBlock(region);
          regionPanel.appendChild(block);
        });

        // 綁定地區選擇事件
        data["regions"].forEach(region => {
          const checkbox = document.getElementById(region.id);
          checkbox.addEventListener('change', (event) => {
            if (event.target.checked) {
              handle_region_change(region.id, data.regions);
            }
          });
        });

        // 設定預設選取台北市
        const tpeCheckbox = document.getElementById('check_tpe');
        if (tpeCheckbox) {
          tpeCheckbox.checked = true;
        }

        // 定位並動態插入生活機能面板
        const lifeFunctionPanel = document.querySelector(".w-96"); // 根據 class 定位 panel
        data["life_function"].forEach(cat => {
          const block = createCategoryBlock(cat);
          lifeFunctionPanel.appendChild(block);
        });

        // 綁定選單展開隱藏
        document.querySelectorAll('.toggle-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const subList = btn.parentElement.nextElementSibling;
            const isOpen = subList.classList.contains('open');
            subList.classList.toggle('open', !isOpen);
            btn.classList.toggle('open', !isOpen);
          });
        });

        // 綁定外&內層列表點擊事件
        data["life_function"].forEach(cat => {
          document.getElementById(cat["id"]).addEventListener('change', (event) => {toggle_category(event, cat["id"])});
          cat["items"].forEach(item => {
            document.getElementById(item["id"]).addEventListener('change', (event) => {toggle_shop(event, cat["label"], item["label"], cat["color"])})
          })
        });
      })
  </script>
</body>
</html>