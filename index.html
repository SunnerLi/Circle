<!-- Usage: python3 -m http.server -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>台北市機能地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 地圖 */
    #map { height: 100vh; width: 100%; }

    /* 店家標記 */
    .marker-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .color-button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .custom-marker {
      width: 25px;
      height: 41px;
      border-radius: 4px;
      position: relative;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }

    .custom-marker::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-top-color: inherit;
    }

    /* 控制面板 */
    .sub-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .sub-list.open {
      max-height: 500px; /* 根據內容大小調整 */
    }

    .toggle-btn.open {
      transform: rotate(90deg);
      transition: transform 0.3s ease;
    }

    .toggle-btn {
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 控制面板 -->
  <div class="absolute top-4 right-4 flex items-start space-x-2 z-[1000]">
    <!-- 地區 Panel -->
    <div id="region-panel" class="bg-white rounded-xl shadow-lg p-4 font-sans w-48">
      <h2 class="text-gray-800 text-sm font-semibold mb-2">地區</h2>
    </div>

    <!-- 機能 Panel -->
    <div class="bg-white rounded-xl shadow-lg p-4 font-sans w-96">
      <h2 class="text-gray-800 text-sm font-semibold mb-2">機能選項</h2>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([25.0330, 121.5654], 13); // 台北市中心

    // 宣告圖層相關物件
    let circles = {}
    let markers = {}

    // 加入 OpenStreetMap 圖層
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 暫停函式
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 查詢Open Street伺服器
    async function query_server(cities, category, shop, color) {
      let allResults = [];
      for (const city of cities) {
        const overpassQuery = `
          [out:json][timeout:25];
          area["name"="${city}"]->.searchArea;
          (
            node["name"~"${shop}"](area.searchArea);
            way["name"~"${shop}"](area.searchArea);
            relation["name"~"${shop}"](area.searchArea);
          );
          out center;
        `;

        for (let i = 0; i < 5; i++) {
          // 定義OpenStreetMap的API URL
          const url = [
            'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery),
            'https://overpass.kumi.systems/api/interpreter?data=' + encodeURIComponent(overpassQuery),
            'https://overpass.osm.ch/api/interpreter?data=' + encodeURIComponent(overpassQuery),
          ][Math.floor(Math.random() * (2 - 0 + 1)) + 0]

          try {
            console.log(url)
            const res = await fetch(url);
            if (res.ok) {
              const json = await res.json();
              console.log(`第${i}次. #${shop}: ` + json.elements.length)
              if (json.elements.length > 0) {
                // (3) 當點擊餐廳panel的選項後，會發送API與openstreet伺服器互動，當收到response後，除了原先畫圖的功能以外，可以將更新的內容寫到緩存中
                const cacheKey = `${cities.join('_')}-${category}-${shop}`;
                updateCache(cacheKey, json);
                allResults.push(...json.elements);
                break
              }
            } else {
              console.log(`第${i}次不ok.`)
              await sleep(Math.floor(Math.random() * (30000 - 1000 + 1)) + 1000)
            }
          } catch (e) {
            console.error("Failed Overpass API for city:", city, e);
          }
        }
      }

      // 將 Overpass API 格式轉換為 compute 函數期望的格式
      return allResults.map(el => {
        let lat = el.lat || (el.center && el.center.lat);
        let lon = el.lon || (el.center && el.center.lon);
        return {
          city: cities[0], // 注意：這裡簡化為第一個城市
          category: category,
          shop: shop,
          latitude: lat,
          longitude: lon,
          color: color
        };
      });
    }

    function compute(rows) {
      rows.forEach(row => {
        markers[row.category][row.shop] = markers[row.category][row.shop].concat(
          L.marker([row.latitude, row.longitude], {icon: createDivIcon(row.shop, row.color)})
        )
        circles[row.category][row.shop] = circles[row.category][row.shop].concat(
          L.circle([row.latitude, row.longitude], {
            radius: 200,
            color: row.color,
            fillOpacity: 0.1
          })
        )
      })
    }

    function createDivIcon(shop_name, color) {
      return L.divIcon({
        className: '',
        html: `<div class="custom-marker" style="background-color:${color}; border-top-color:${color};">
                <span>${shop_name}</span>
               </div>`,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, -41]
      });
    }

    function draw(category, shop) {
      circles[category][shop].forEach(circle => {
        circle.addTo(map)
      })
      markers[category][shop].forEach(marker => {
        marker.addTo(map).bindPopup(shop)
      })
    }

    function erase(category, shop) {
      circles[category][shop].forEach(circle => {
        map.removeLayer(circle)
      })
      markers[category][shop].forEach(marker => {
        map.removeLayer(marker)
      })
    }

    // --- Caching functions ---
    const CACHE_KEY_PREFIX = 'mapCache';

    function getCache(key) {
      const cached = localStorage.getItem(`${CACHE_KEY_PREFIX}_${key}`);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          // 確保返回的格式與 Overpass API 一致
          return data.elements ? data : { elements: data };
        } catch (e) {
          console.error("Failed to parse cache:", e);
          return null;
        }
      }
      return null;
    }

    function updateCache(key, data) {
        // 確保傳入的 data 有 elements 屬性
        const dataToCache = data.elements ? data : { elements: data };

        // (5) 請注意在更新緩存內容時，是更新內容不是覆蓋內容，如果緩存內部有10間鐵板燒餐廳的資訊，但當下與伺服器互動取到的response是0筆，則代表當下response有誤，不是直接覆蓋變成0筆
        if (!dataToCache || !dataToCache.elements || dataToCache.elements.length === 0) {
            const existingData = getCache(key);
            if (existingData && existingData.elements && existingData.elements.length > 0) {
                console.log(`Cache: Received 0 elements for ${key}. Preserving existing cache.`);
                return; // 不更新快取
            }
        }

        // (4) 請注意同一時間可能會有多個checkbox被點擊，並且有多個request與openstreet伺服器互動，每次response都會寫入緩存，因此要考慮是否有conflict並避免它
        // 解法：每個 request 都只寫自己的 key，不會互相影響
        try {
            localStorage.setItem(`${CACHE_KEY_PREFIX}_${key}`, JSON.stringify(dataToCache));
            console.log(`Cache: Updated cache for ${key}`);
        } catch (e) {
            console.error("Failed to update cache:", e);
            // 可選：增加更複雜的錯誤處理，例如清除部分舊快取
        }
    }

    /**
     * 處理點擊/取消點擊商店checkbox的行為
     */
    function toggle_shop(event, category, shop, color) {
      const selectedCities = get_selected_cities();
      const cacheKey = `${selectedCities.join('_')}-${category}-${shop}`;

      if (event.target.checked) {
        // (1) 當切換地區panel時，會讀取緩存內是否有暫存資料，如果有的話則讀入緩存資料
        const cachedData = getCache(cacheKey);

        if (cachedData && cachedData.elements.length > 0) {
          console.log(`Cache HIT for key: ${cacheKey}. Rendering from cache.`);
          // (2) 讀入緩存資料後，會根據資料內容渲染畫面
          // 將 Overpass API 格式轉換為 query_db 的格式
          const rows = cachedData.elements.map(el => {
            let lat = el.lat || (el.center && el.center.lat);
            let lon = el.lon || (el.center && el.center.lon);
            return {
              city: selectedCities[0], // 注意：這裡簡化為第一個城市
              category: category,
              shop: shop,
              latitude: lat,
              longitude: lon,
              color: color
            };
          });
          compute(rows);
          draw(category, shop);
        } else {
          console.log(`Cache MISS for key: ${cacheKey}. Querying server.`);
          query_server(selectedCities, category, shop, color).then(rows => {
            compute(rows)
            draw(category, shop)
          })
        }
      } else {
        erase(category, shop)
      }
    }

    function get_selected_cities() {
      const selectedCities = [];
      const regionCheckboxes = document.querySelectorAll('#region-panel input[type="checkbox"]:checked');
      regionCheckboxes.forEach(checkbox => {
        const label = checkbox.closest('label');
        if (label) {
          const span = label.querySelector('span');
          if (span) {
            selectedCities.push(span.textContent.trim());
          }
        }
      });
      return selectedCities.length > 0 ? selectedCities : ["台北市"]; // Default to 台北市 if none selected
    }

    /**
     * 處理點擊/取消點擊餐廳類別checkbox的行為
     */
    function toggle_category(event, category_id) {
      const mainCheckbox = document.getElementById(category_id)
      const itemDiv = mainCheckbox.closest('.mb-4')
      const subList = itemDiv.querySelector('.sub-list')
      const subCheckboxes = subList.querySelectorAll('input[type="checkbox"]')

      if (event.target.checked) {
        expandSublist(category_id)
        subCheckboxes.forEach(cb => {if (!cb.checked) {cb.click()}});
      } else {
        subCheckboxes.forEach(cb => {if (cb.checked) {cb.click()}});
      }
    }

    /**
     * 處理點擊地區checkbox的行為
     */
    function handle_region_change(regionId, regions) {
      const regionCheckboxes = document.querySelectorAll('#region-panel input[type="checkbox"]');
      regionCheckboxes.forEach(checkbox => {
        if (checkbox.id !== regionId) {
          checkbox.checked = false;
        }
      });

      const selectedRegion = regions.find(r => r.id === regionId);
      if (selectedRegion) {
        map.setView([selectedRegion.lat, selectedRegion.lng], 13);
      }
    }

    // UI渲染函數
    function createRegionBlock({ id, label }) {
      const container = document.createElement("div");
      container.className = "mb-2";
      container.innerHTML = `
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="${id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">${label}</span>
        </label>
      `;
      return container;
    }

    function createCategoryBlock({ id, label, items }) {
      const container = document.createElement("div");
      container.className = "mb-4 border-b border-gray-300";
      container.innerHTML = `
        <div class="flex justify-between items-center">
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="${id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">${label}</span>
          </label>
          <button class="toggle-btn text-gray-600">▶</button>
        </div>

        <div class="sub-list pl-6 flex flex-wrap mt-2">
          ${items.map(item => `
            <div class="flex items-center space-x-1 w-1/3 mb-2">
              <label class="inline-flex items-center space-x-2 cursor-pointer">
                <input type="checkbox" id="${item.id}" class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
                <span class="text-sm text-gray-900">${item.label}</span>
              </label>
            </div>
          `).join('')}
        </div>
      `;
      return container;
    }

    // 手動展開子列表
    function expandSublist(mainId, expand = true) {
      const mainCheckbox = document.getElementById(mainId);
      const itemDiv = mainCheckbox?.closest(".mb-4");
      const subList = itemDiv?.querySelector(".sub-list");
      const toggleBtn = itemDiv?.querySelector(".toggle-btn");

      if (subList && toggleBtn) {
        subList.classList.toggle("open", expand);
        toggleBtn.classList.toggle("open", expand);
      }
    }

    // 讀取JSON設定檔並根據內容渲染面板
    fetch('setting.json')
      .then(res => res.json())
      .then(data => {
        // 初始化圖層相關變數
        data["life_function"].forEach(cat => {
          circles[cat["label"]] = {}
          markers[cat["label"]] = {}
          cat["items"].forEach(item => {
            circles[cat["label"]][item["label"]] = []
            markers[cat["label"]][item["label"]] = []
          })
        })

        // 定位並動態插入地區面板
        const regionPanel = document.getElementById("region-panel");
        data["regions"].forEach(region => {
          const block = createRegionBlock(region);
          regionPanel.appendChild(block);
        });

        // 綁定地區選擇事件
        data["regions"].forEach(region => {
          const checkbox = document.getElementById(region.id);
          checkbox.addEventListener('change', (event) => {
            if (event.target.checked) {
              handle_region_change(region.id, data.regions);
            }
          });
        });

        // 設定預設選取台北市
        const tpeCheckbox = document.getElementById('check_tpe');
        if (tpeCheckbox) {
          tpeCheckbox.checked = true;
        }

        // 定位並動態插入生活機能面板
        const lifeFunctionPanel = document.querySelector(".w-96"); // 根據 class 定位 panel
        data["life_function"].forEach(cat => {
          const block = createCategoryBlock(cat);
          lifeFunctionPanel.appendChild(block);
        });

        // 綁定選單展開隱藏
        document.querySelectorAll('.toggle-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const subList = btn.parentElement.nextElementSibling;
            const isOpen = subList.classList.contains('open');
            subList.classList.toggle('open', !isOpen);
            btn.classList.toggle('open', !isOpen);
          });
        });

        // 綁定外&內層列表點擊事件
        data["life_function"].forEach(cat => {
          document.getElementById(cat["id"]).addEventListener('change', (event) => {toggle_category(event, cat["id"])});
          cat["items"].forEach(item => {
            document.getElementById(item["id"]).addEventListener('change', (event) => {toggle_shop(event, cat["label"], item["label"], cat["color"])})
          })
        });
      })
  </script>
</body>
</html>