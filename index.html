<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>台北市機能地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* 地圖 */
    #map { height: 100vh; width: 100%; }

    /* 店家標記 */
    .marker-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .color-button {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
    }

    .custom-marker {
      width: 25px;
      height: 41px;
      border-radius: 4px;
      position: relative;
      box-shadow: 0 0 2px rgba(0,0,0,0.5);
    }

    .custom-marker::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-top-color: inherit;
    }

    /* 控制面板 */
    .sub-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .sub-list.open {
      max-height: 500px; /* 根據內容大小調整 */
    }

    .toggle-btn.open {
      transform: rotate(90deg);
      transition: transform 0.3s ease;
    }

    .toggle-btn {
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- 控制面板 -->
  <div class="absolute top-4 right-4 bg-white rounded-xl shadow-lg p-4 z-[1000] w-96 font-sans">
    <h2 class="text-gray-800 text-sm font-semibold mb-2">機能選項</h2>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_dumpling" class="form-checkbox" />
          <label for="check_dumpling" class="text-gray-800">水餃/鍋貼</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_dumpling"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">水餃/鍋貼</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_eight" class="form-checkbox" />
          <label for="check_eight" class="text-sm text-gray-700">八方雲集</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_four" class="form-checkbox" />
          <label for="check_four" class="text-sm text-gray-700">四海遊龍</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="radio" id="check_eight" class="custom-checkbox" />
          <label for="check_eight" class="text-sm text-gray-700">八方雲集</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_eight"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">八方雲集</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="radio" id="check_four" class="custom-checkbox" />
          <label for="check_four" class="text-sm text-gray-700">四海遊龍</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_four"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">四海遊龍</span>
          </label>
        </div>
      </div>
  
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_fast" class="form-checkbox" />
          <label for="check_fast" class="text-gray-800">速食</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_fast"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">速食</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_mc" class="form-checkbox" />
          <label for="check_mc" class="text-sm text-gray-700">麥當勞</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_kfc" class="form-checkbox" />
          <label for="check_kfc" class="text-sm text-gray-700">肯德基</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_mos" class="form-checkbox" />
          <label for="check_mos" class="text-sm text-gray-700">摩斯漢堡</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_mc" class="form-checkbox" />
          <label for="check_mc" class="text-sm text-gray-700">麥當勞</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_mc"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">麥當勞</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_kfc" class="form-checkbox" />
          <label for="check_kfc" class="text-sm text-gray-700">肯德基</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_kfc"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">肯德基</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_mos" class="form-checkbox" />
          <label for="check_mos" class="text-sm text-gray-700">摩斯漢堡</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_mos"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">摩斯漢堡</span>
          </label>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_iron" class="form-checkbox" />
          <label for="check_iron" class="text-gray-800">鐵板燒（不限連鎖）</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_iron"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">鐵板燒（不限連鎖）</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_dapu" class="form-checkbox" />
          <label for="check_dapu" class="text-sm text-gray-700">鐵板燒</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_dapu" class="form-checkbox" />
          <label for="check_dapu" class="text-sm text-gray-700">鐵板燒</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_dapu"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">鐵板燒</span>
          </label>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_market" class="form-checkbox" />
          <label for="check_market" class="text-gray-800">大賣場</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_market"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">大賣場</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_px" class="form-checkbox" />
          <label for="check_px" class="text-sm text-gray-700">全聯福利中心</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_home" class="form-checkbox" />
          <label for="check_home" class="text-sm text-gray-700">家樂福</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_px" class="form-checkbox" />
          <label for="check_px" class="text-sm text-gray-700">全聯福利中心</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_px"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">全聯福利中心</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_home" class="form-checkbox" />
          <label for="check_home" class="text-sm text-gray-700">家樂福</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_home"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">家樂福</span>
          </label>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_br" class="form-checkbox" />
          <label for="check_br" class="text-gray-800">連鎖早餐店</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_br"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">連鎖早餐店</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_mei" class="form-checkbox" />
          <label for="check_mei" class="text-sm text-gray-700">美而美</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_hongya" class="form-checkbox" />
          <label for="check_hongya" class="text-sm text-gray-700">弘爺漢堡</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_mei" class="form-checkbox" />
          <label for="check_mei" class="text-sm text-gray-700">美而美</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_mei"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">美而美</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_hongya" class="form-checkbox" />
          <label for="check_hongya" class="text-sm text-gray-700">弘爺漢堡</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_hongya"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">弘爺漢堡</span>
          </label>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_bengdong" class="form-checkbox" />
          <label for="check_bengdong" class="text-gray-800">便當店</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_bengdong"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">便當店</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_chang" class="form-checkbox" />
          <label for="check_chang" class="text-sm text-gray-700">鬍鬚張</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_liang" class="form-checkbox" />
          <label for="check_liang" class="text-sm text-gray-700">梁社漢</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_three" class="form-checkbox" />
          <label for="check_three" class="text-sm text-gray-700">三商巧福</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_self" class="form-checkbox" />
          <label for="check_self" class="text-sm text-gray-700">自助餐</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_chang" class="form-checkbox" />
          <label for="check_chang" class="text-sm text-gray-700">鬍鬚張</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_chang"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">鬍鬚張</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_liang" class="form-checkbox" />
          <label for="check_liang" class="text-sm text-gray-700">梁社漢</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_liang"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">梁社漢</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_three" class="form-checkbox" />
          <label for="check_three" class="text-sm text-gray-700">三商巧福</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_three"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">三商巧福</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_self" class="form-checkbox" />
          <label for="check_self" class="text-sm text-gray-700">自助餐</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_self"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">自助餐</span>
          </label>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="flex justify-between items-center">
        <!-- <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_hotpod" class="form-checkbox" />
          <label for="check_hotpod" class="text-gray-800">平價火鍋</label>
        </div> -->
        <label class="inline-flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="check_hotpod"
            class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
          <span class="text-sm text-gray-900">平價火鍋</span>
        </label>
        <button class="toggle-btn text-gray-600">▶</button>
      </div>

      <!-- <div class="sub-list pl-6 mt-2 space-y-2">
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_lima" class="form-checkbox" />
          <label for="check_lima" class="text-sm text-gray-700">麗媽</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_8kuo" class="form-checkbox" />
          <label for="check_8kuo" class="text-sm text-gray-700">8鍋</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_3kuo" class="form-checkbox" />
          <label for="check_3kuo" class="text-sm text-gray-700">三媽臭臭鍋</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_3mao" class="form-checkbox" />
          <label for="check_3mao" class="text-sm text-gray-700">三顧茅廬</label>
        </div>
        <div class="flex items-center space-x-2">
          <input type="checkbox" id="check_six" class="form-checkbox" />
          <label for="check_six" class="text-sm text-gray-700">六扇門</label>
        </div>
      </div> -->

      <div class="sub-list pl-6 flex flex-wrap mt-2">
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_lima" class="form-checkbox" />
          <label for="check_lima" class="text-sm text-gray-700">麗媽</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_lima"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">麗媽</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_8kuo" class="form-checkbox" />
          <label for="check_8kuo" class="text-sm text-gray-700">8鍋</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_8kuo"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">8鍋</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_3kuo" class="form-checkbox" />
          <label for="check_3kuo" class="text-sm text-gray-700">三媽臭臭鍋</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_3kuo"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">三媽臭臭鍋</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_3mao" class="form-checkbox" />
          <label for="check_3mao" class="text-sm text-gray-700">三顧茅廬</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_3mao"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">三顧茅廬</span>
          </label>
        </div>
        <div class="flex items-center space-x-1 w-1/3 mb-2">
          <!-- <input type="checkbox" id="check_six" class="form-checkbox" />
          <label for="check_six" class="text-sm text-gray-700">六扇門</label> -->
          <label class="inline-flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="check_six"
              class="w-5 h-5 accent-green-600 bg-white border-gray-300 rounded"/>
            <span class="text-sm text-gray-900">六扇門</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 建立地圖
    const map = L.map('map').setView([25.0330, 121.5654], 13); // 台北市中心

    // 加入 OpenStreetMap 圖層
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 創建data dict，用來收集資料：data = {'eight': {meta: [], marker: [], circle: []}, ...}
    // ref: https://github.com/pointhi/leaflet-color-markers/tree/master/img
    let data = {
      '水餃/鍋貼': {
        '八方雲集': {'meta': null, 'marker': [], 'circle': [], 'color': '#FFF75C'},
        '四海遊龍': {'meta': null, 'marker': [], 'circle': [], 'color': '#FFF75C'},
      },
      '速食': {
        '麥當勞': {'meta': null, 'marker': [], 'circle': [], 'color': '#FFB937'},
        '肯德基': {'meta': null, 'marker': [], 'circle': [], 'color': '#FFB937'},
        '摩斯漢堡': {'meta': null, 'marker': [], 'circle': [], 'color': '#FFB937'},
      },
      '鐵板燒（不限連鎖）': {
        '鐵板燒': {'meta': null, 'marker': [], 'circle': [], 'color': '#50796C'},
      },
      '大賣場': {
        '全聯福利中心': {'meta': null, 'marker': [], 'circle': [], 'color': '#004FF0'},
        '家樂福': {'meta': null, 'marker': [], 'circle': [], 'color': '#004FF0'},
      },
      '連鎖早餐店': {
        '美而美': {'meta': null, 'marker': [], 'circle': [], 'color': '#DD6476'},
        '弘爺漢堡': {'meta': null, 'marker': [], 'circle': [], 'color': '#DD6476'},
      },
      '便當店': {
        '鬍鬚張': {'meta': null, 'marker': [], 'circle': [], 'color': '#FF2C14'},
        '梁社漢': {'meta': null, 'marker': [], 'circle': [], 'color': '#FF2C14'},
        '三商巧福': {'meta': null, 'marker': [], 'circle': [], 'color': '#FF2C14'},
        '自助餐': {'meta': null, 'marker': [], 'circle': [], 'color': '#FF2C14'},
      },
      '平價火鍋': {
        '麗媽': {'meta': null, 'marker': [], 'circle': [], 'color': '#FD0531'},
        '8鍋': {'meta': null, 'marker': [], 'circle': [], 'color': '#FD0531'},
        '三媽臭臭鍋': {'meta': null, 'marker': [], 'circle': [], 'color': '#FD0531'},
        '三顧茅廬': {'meta': null, 'marker': [], 'circle': [], 'color': '#FD0531'},
        '六扇門': {'meta': null, 'marker': [], 'circle': [], 'color': '#FD0531'},
      }
    }

    // 暫停函式
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // 回傳 300~1000ms 之間的隨機數
    function getRandomInteger(min = 1000, max = 10000) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    async function search(category_name, shop_name) {
      // 如果尚未有搜尋資料，則先搜一次
      if (!data[category_name][shop_name]["meta"] || data[category_name][shop_name]["meta"].elements.length == 0) {
        // 使用 Overpass API 搜尋八方雲集
        // const query = `
        //     [out:json][timeout:25];
        //     area["name"="臺北市"]->.searchArea;
        //     (
        //         node["name"~"${shop_name}"](area.searchArea);
        //         way["name"~"${shop_name}"](area.searchArea);
        //         relation["name"~"${shop_name}"](area.searchArea);
        //     );
        //     out center;
        // `;
        const query = `
            [out:json][timeout:25];

            // 定義兩個 area
            area["name"="臺北市"]->.taipei;
            area["name"="新北市"]->.newtaipei;

            // 將兩個 area 合併
            (
              node["name"~"${shop_name}"](area.taipei);
              way["name"~"${shop_name}"](area.taipei);
              relation["name"~"${shop_name}"](area.taipei);
              
              node["name"~"${shop_name}"](area.newtaipei);
              way["name"~"${shop_name}"](area.newtaipei);
              relation["name"~"${shop_name}"](area.newtaipei);
            );
            out center;
        `

        // 定義4個OpenStreetMap的API URL
        let urls = [
          'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query),
          'https://overpass.kumi.systems/api/interpreter?data=' + encodeURIComponent(query),
          'https://overpass.osm.ch/api/interpreter?data=' + encodeURIComponent(query),
        ]

        // 透過fetch獲取資訊，失敗則睡覺一陣子後換伺服器，最多嘗試30次
        for (let i = 0; i < 30; i++) {
          let url = urls[getRandomInteger(0, 2)]
          try {
            let res = await fetch(url)
            if (res.ok) {
              data[category_name][shop_name]["meta"] = await res.json()
              if (data[category_name][shop_name]["meta"].elements.length > 0) {
                break
              }
            } else {
              await sleep(getRandomInteger(1000, 30000))
            }
          } catch (err) {
            console.warn(`Failed to fetch from ${url}`, err);
          }
        }
      }
    }

    function compute(category_name, shop_name) {
      if (data[category_name][shop_name]["meta"].elements.length > 0) {
        data[category_name][shop_name]["circle"] = []
        data[category_name][shop_name]["marker"] = []

        data[category_name][shop_name]["meta"].elements.forEach(el => {
          const lat = el.lat || el.center?.lat;
          const lon = el.lon || el.center?.lon;

          if (!lat || !lon) return;

          const name = el.tags?.name || shop_name;

          // 建立icon
          const icon = L.icon({
            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/${data[category_name][shop_name]["color"]}.png`,
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
          });

          // 加入 marker
          // data[shop_name]["marker"] = data[shop_name]["marker"].concat(L.marker([lat, lon], {icon: icon}))
          data[category_name][shop_name]["marker"] = data[category_name][shop_name]["marker"].concat(L.marker([lat, lon], {icon: createDivIcon(shop_name, data[category_name][shop_name]["color"])}))

          // 畫出 500 公尺的圓
          data[category_name][shop_name]["circle"] = data[category_name][shop_name]["circle"].concat(
            L.circle([lat, lon], {
              radius: 200,
              color: data[category_name][shop_name]["color"],
              fillOpacity: 0.1
            })
          )
        });
      }
    }

    function createDivIcon(shop_name, color) {
      return L.divIcon({
        className: '',
        html: `<div class="custom-marker" style="background-color:${color}; border-top-color:${color};">
                <span>${shop_name}</span>
               </div>`,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [0, -41]
      });
    }

    function draw(category_name, shop_name) {
      if (data[category_name][shop_name]["circle"].length > 0) {
        data[category_name][shop_name]["circle"].forEach(circle => {
          circle.addTo(map)
        })
      }
      if (data[category_name][shop_name]["marker"].length > 0) {
        data[category_name][shop_name]["marker"].forEach(marker => {
          marker.addTo(map).bindPopup(shop_name)
        })
      }
    }

    function erase(category_name, shop_name) {
      if (data[category_name][shop_name]["circle"].length > 0) {
        data[category_name][shop_name]["circle"].forEach(circle => {
          map.removeLayer(circle)
        })
      }
      if (data[category_name][shop_name]["marker"].length > 0) {
        data[category_name][shop_name]["marker"].forEach(marker => {
          map.removeLayer(marker)
        })
      }
    }

    function toggle_shop(event, category_name, shop_name) {
      if (event.target.checked) {
        // 如果尚未有搜尋資料，則先搜一次
        if (!data[category_name][shop_name]["meta"] || data[category_name][shop_name]["meta"].elements.length == 0) {
          search(category_name, shop_name).then(() => {
            compute(category_name, shop_name)
            draw(category_name, shop_name)
          })
        } else {
          compute(category_name, shop_name)
          draw(category_name, shop_name)
        }
      } else {
        if (data[category_name][shop_name]["circle"]) {
          erase(category_name, shop_name)
        }
      }
    }

    function toggle_category(event, category_id) {
      const mainCheckbox = document.getElementById(category_id)
      const itemDiv = mainCheckbox.closest('.mb-4')
      const subList = itemDiv.querySelector('.sub-list')
      const subCheckboxes = subList.querySelectorAll('input[type="checkbox"]')

      if (event.target.checked) {
        expandSublist(category_id)
        subCheckboxes.forEach(cb => {if (!cb.checked) {cb.click()}});
      } else {
        subCheckboxes.forEach(cb => {if (cb.checked) {cb.click()}});
      }
    }

    // 手動展開子列表
    function expandSublist(mainId, expand = true) {
      const mainCheckbox = document.getElementById(mainId);
      const itemDiv = mainCheckbox?.closest(".mb-4");
      const subList = itemDiv?.querySelector(".sub-list");
      const toggleBtn = itemDiv?.querySelector(".toggle-btn");

      if (subList && toggleBtn) {
        subList.classList.toggle("open", expand);
        toggleBtn.classList.toggle("open", expand);
      }
    }

    // 綁定內層列表點擊事件
    document.getElementById('check_eight' ).addEventListener('change', (event) => {toggle_shop(event, "水餃/鍋貼", "八方雲集")});
    document.getElementById('check_four'  ).addEventListener('change', (event) => {toggle_shop(event, "水餃/鍋貼", "四海遊龍")});
    document.getElementById('check_mc'    ).addEventListener('change', (event) => {toggle_shop(event, "速食", "麥當勞")});
    document.getElementById('check_kfc'   ).addEventListener('change', (event) => {toggle_shop(event, "速食", "肯德基")});
    document.getElementById('check_mos'   ).addEventListener('change', (event) => {toggle_shop(event, "速食", "摩斯漢堡")});
    document.getElementById('check_dapu'  ).addEventListener('change', (event) => {toggle_shop(event, "鐵板燒（不限連鎖）", "鐵板燒")});
    document.getElementById('check_px'    ).addEventListener('change', (event) => {toggle_shop(event, "大賣場", "全聯福利中心")});
    document.getElementById('check_home'  ).addEventListener('change', (event) => {toggle_shop(event, "大賣場", "家樂福")});
    document.getElementById('check_mei'   ).addEventListener('change', (event) => {toggle_shop(event, "連鎖早餐店", "美而美")});
    document.getElementById('check_hongya').addEventListener('change', (event) => {toggle_shop(event, "連鎖早餐店", "弘爺漢堡")});
    document.getElementById('check_chang' ).addEventListener('change', (event) => {toggle_shop(event, "便當店", "鬍鬚張")});
    document.getElementById('check_liang' ).addEventListener('change', (event) => {toggle_shop(event, "便當店", "梁社漢")});
    document.getElementById('check_three' ).addEventListener('change', (event) => {toggle_shop(event, "便當店", "三商巧福")});
    document.getElementById('check_self'  ).addEventListener('change', (event) => {toggle_shop(event, "便當店", "自助餐")});
    document.getElementById('check_lima'  ).addEventListener('change', (event) => {toggle_shop(event, "平價火鍋", "麗媽")});
    document.getElementById('check_8kuo'  ).addEventListener('change', (event) => {toggle_shop(event, "平價火鍋", "8鍋")});
    document.getElementById('check_3kuo'  ).addEventListener('change', (event) => {toggle_shop(event, "平價火鍋", "三媽臭臭鍋")});
    document.getElementById('check_3mao'  ).addEventListener('change', (event) => {toggle_shop(event, "平價火鍋", "三顧茅廬")});
    document.getElementById('check_six'   ).addEventListener('change', (event) => {toggle_shop(event, "平價火鍋", "六扇門")});

    // 綁定外層列表點擊事件
    document.getElementById('check_dumpling').addEventListener('change', (event) => {toggle_category(event, "check_dumpling")});
    document.getElementById('check_fast'    ).addEventListener('change', (event) => {toggle_category(event, "check_fast")});
    document.getElementById('check_iron'    ).addEventListener('change', (event) => {toggle_category(event, "check_iron")});
    document.getElementById('check_market'  ).addEventListener('change', (event) => {toggle_category(event, "check_market")});
    document.getElementById('check_br'      ).addEventListener('change', (event) => {toggle_category(event, "check_br")});
    document.getElementById('check_bengdong').addEventListener('change', (event) => {toggle_category(event, "check_bengdong")});
    document.getElementById('check_hotpod'  ).addEventListener('change', (event) => {toggle_category(event, "check_hotpod")});


    // 綁定選單展開隱藏
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const subList = btn.parentElement.nextElementSibling;
        const isOpen = subList.classList.contains('open');
        subList.classList.toggle('open', !isOpen);
        btn.classList.toggle('open', !isOpen);
      });
    });
  </script>
</body>
</html>